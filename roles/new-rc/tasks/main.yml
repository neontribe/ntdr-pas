---
- name: Fix latest permissions
  shell: sudo ntdrchown {{ source }}

- ntdr_get_version.py: path={{ source }}
  register: source_version

- stat: path={{ source }}/sites/all/drush/{{ source_version.stat.shortver }}.alias.drushrc.php
  register: source_alias
  tags: always

- name: Create alias file
  ntdr_create_drushrc_alias.py: path = "{{ source }}"
  when: not source_alias.stat.exists
  tags: alias

- stat: path={{ target }}
  register: target_dir

# These two should be a single rsync with a switch but I can't get it to work
- name: Sync Live to RC
  shell: rsync -a {{ source_version.stat.realpath }}/* {{ target }}
  when: target_dir.stat.exists

- name: Sync Live to RC
  shell: rsync -a {{ source_version.stat.realpath }}/ {{ target }}
  when: not target_dir.stat.exists

- ntdr_get_version.py: path={{ target }}
  register: target_version

- name: Fix database in settings.php
  lineinfile:
    dest: "{{ target }}/sites/default/settings.php"
    regexp: "database' => "
    line: "      'database' => '{{ target_version.stat.version }}',"
- name: Fix username in settings.php
  lineinfile:
    dest: "{{ target }}/sites/default/settings.php"
    regexp: "username' => "
    line: "      'username' => '{{ target_version.stat.version }}',"
- name: Fix password in settings.php
  lineinfile:
    dest: "{{ target }}/sites/default/settings.php"
    regexp: "password' => "
    line: "      'password' => '{{ target_version.stat.version }}',"

- name: Create new alias file
  ntdr_create_drushrc_alias.py:
    path: "{{ target }}"
    name: "{{ target_version.stat.shortver }}"
    shortver: "{{ target_version.stat.version }}"
  register: target_alias

- name: Drop local DB and user
  shell: mysql-dropuser-and-db -u {{ target_alias.stat.shortver }} -m {{ mysql_root_pw }}
  tags: db

- name: Create DB
  shell: mysql-create-user-and-db -u {{ target_alias.stat.version }} -p {{ target_alias.stat.version }} -n {{ target_alias.stat.version }} -m {{ mysql_root_pw }}

- name: Dump live DB
  shell: drush sql-dump --ordered-dump --structure-tables-key=common --result-file=/var/tmp/{{ source_version.stat.version }}.sql chdir={{ source }}

- name: Import DB
# shell: "drush -r {{ target }} sqlc < /var/tmp/{{ source_version.stat.version }}.sql"
  mysql_db:
    state: import
    name: "{{ target_alias.stat.version }}"
    login_user: "{{ target_alias.stat.version }}"
    login_password: "{{ target_alias.stat.version }}"
    target: /var/tmp/{{ source_version.stat.version }}.sql

- name: Run up and updb
  shell: drush --verbose -y --uri=default @self chdir={{ target }} up
  shell: drush --verbose -y --uri=default @self chdir={{ target }} updb

- name: Set testing symlink to point at RC
  file: path=/var/www/testing state=absent
  file: src={{ target }} dest=/var/www/testing state=link

- name: Fix RC permissions
  shell: sudo ntdrchown {{ target }}

- name: Add no follow robots.txt
  shell: 'echo -e "User-agent: *\nDisallow: /" > {{ target }}/robotx.txt'
