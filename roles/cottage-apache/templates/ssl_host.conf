<VirtualHost *:443>
	ServerAdmin {{ domain_name.split('.')[0] }}@{{ domain_name }}

	ServerName {{ domain_name }}
	ServerAlias {{ item.1 }}.{{ domain_name }}
	DocumentRoot /var/www/{{ item.1 }}

	RewriteEngine on
    	RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
	RewriteRule .* - [F]

	RewriteCond %{HTTP_HOST} !^{{ item.1 }}\. [NC]
	RewriteRule ^(.*)$ https://{{ item.1 }}.%{HTTP_item.1}%{REQUEST_URI} [R=301,L]

	IncludeOptional /etc/apache2/redirects.conf
	IncludeOptional /etc/apache2/expire_rules.conf

	<Directory /var/www/latest>
		AllowOverride All
		Options FollowSymLinks
		Require all granted
	</Directory>

	#set apache headers to ask browser only ever to use https even if the user asks for a http page
    Header set Strict-Transport-Security "max-age=31536000" env=HTTPS
    #it is likely that we may need to not include HttpOnly if we use cookies in js(eg in booking)
    Header always edit Set-Cookie ^(.*)$ $1;Secure
    #Header edit Set-Cookie ^(.*)$ $1;Secure;HttpOnly
    #some browsers read this and enable thier XSS protection even if the user has disabled it
    Header always set X-XSS-Protection: "1; mode=block"
    #Stop some browsers for trying to guess mimetypes
    Header always set X-Content-Type-Options nosniff

	#Loglevel debug rewrite:trace3
	ErrorLog ${APACHE_LOG_DIR}/{{ item.1 }}_error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	SSLEngine on
	#SSLCipherSuite LOW:MEDIUM:HIGH
    SSLProtocol  ALL  -SSLv2 -SSLv3
    SSLHonorCipherOrder  On
    SSLCipherSuite  ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    #For Apache 2.2.24+ and 2.4.3+ uncomment below
    SSLCompression  Off

	SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
	SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

	<FilesMatch "\.(cgi|shtml|phtml|php)$">
		SSLOptions +StdEnvVars
	</FilesMatch>
	<Directory /usr/lib/cgi-bin>
		SSLOptions +StdEnvVars
	</Directory>

	BrowserMatch "MSIE [2-6]" \
			nokeepalive ssl-unclean-shutdown \
			downgrade-1.0 force-response-1.0
	# MSIE 7 and newer should be able to use keepalive
	BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

</VirtualHost>
# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
