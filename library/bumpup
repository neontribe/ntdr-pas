#! /usr/bin/env python

import sys, os, json, shlex, re, json
from git import Git, Repo
from datetime import datetime

def clearNonNumeric(ele):
    return re.sub("[^0-9]", "", ele)

def main():
    module = AnsibleModule(
        argument_spec = dict(
            repo = dict(required=True),
            bump = dict(required=True),
            tag = dict(required=True),
        ),
    )

    repopath = module.params.get('repo')
    bump = module.params.get('bump')
    latest_tag = module.params.get('tag')

    data = {}

    # Roll up the tag
    tags = re.findall(r"\d+", str(latest_tag))
    if len(tags) >= 3:
        tags = [clearNonNumeric(tags[0]), clearNonNumeric(tags[1]), clearNonNumeric(tags[2])]
    elif len(tags) == 2:
        tags = [0, clearNonNumeric(tags[0]), clearNonNumeric(tags[1])]
    elif len(tags) == 1:
        tags = [1, 0, clearNonNumeric(tags[0])]
    elif len(tags) == 0:
        tags = [0, 0, 0]

    if bump == 'major':
        tags[0] = int(tags[0]) + 1
        tags[1] = 0
        tags[2] = 0
    elif bump == 'minor':
        tags[0] = int(tags[0])
        tags[1] = int(tags[1]) + 1
        tags[2] = 0
    else:
        tags[2] = int(tags[2]) + 1

    new_tag = 'v' + str(tags[0]) + '_' + str(tags[1]) + '_' + str(tags[2])
    data['new_tag'] = new_tag

    module.exit_json(changed=True, stat=data)

from ansible.module_utils.basic import *

main()
